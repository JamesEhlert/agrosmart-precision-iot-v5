// Espa√ßo para snippets de c√≥digo antigos

üèõÔ∏è Estrutura do Banco de Dados (Firestore NoSQL)

No Firestore, trabalhamos com Cole√ß√µes (pastas) e Documentos (arquivos). Para o seu caso (Multi-usu√°rio + Logs de Auditoria), esta √© a estrutura mais profissional e otimizada:

Vou detalhar o JSON (estrutura) de cada parte:
1. Cole√ß√£o users (Seus Clientes)

Aqui guardamos quem √© o dono. A seguran√ßa do App vai verificar se o uid do usu√°rio logado bate com o owner_uid ou se est√° na lista de access.
JSON

// users/{userID}
{
  "uid": "Kjs83...",       // ID gerado pelo Firebase Auth
  "email": "cliente@fazenda.com",
  "name": "Jo√£o Agricultor",
  "created_at": 1735660000,
  "role": "customer",      // customer, admin, support
  "my_devices": [          // Array r√°pido para o App listar os dispositivos dele
    "ESP32-AgroSmart-Station-V5",
    "ESP32-Estufa-02"
  ]
}

2. Cole√ß√£o devices (Os Equipamentos)

Esta √© a "identidade digital" do ESP32. As configura√ß√µes ficam aqui.
JSON

// devices/{deviceID}
{
  "device_id": "ESP32-AgroSmart-Station-V5",
  "name": "Horta dos Fundos",
  "owner_uid": "Kjs83...", // V√≠nculo de seguran√ßa (Dono)
  "online": true,
  
  // CONFIGURA√á√ïES GERAIS (Settings)
  "settings": {
    "min_moisture": 30,    // Abaixo disso, precisa regar
    "max_moisture": 80,    // Acima disso, N√ÉO rega (Economia)
    "rain_lockout": true,  // Se True, verifica previs√£o do tempo
    "manual_duration": 10, // Segundos do bot√£o manual
    "latitude": -23.55,    // Necess√°rio para API do Tempo
    "longitude": -46.63
  }
}

3. Sub-cole√ß√£o schedules (Os Agendamentos)

Fica dentro do documento do dispositivo (devices/{deviceID}/schedules/).
JSON

// devices/{deviceID}/schedules/{scheduleID}
{
  "label": "Rega Noturna",
  "time": "20:00",
  "days": [1, 3, 5],       // Seg, Qua, Sex
  "duration_seconds": 600, // 10 minutos
  "enabled": true
}

4. Sub-cole√ß√£o history (A Solu√ß√£o para sua D√∫vida) ‚úÖ

Aqui matamos a charada dos logs. Fica dentro do dispositivo (devices/{deviceID}/history/). Salvamos tanto o que foi feito quanto o que foi bloqueado.

Exemplo de Sucesso:
JSON

{
  "timestamp": 1735661000,
  "type": "execution",
  "source": "schedule", // ou "manual"
  "status": "success",
  "message": "Irriga√ß√£o realizada por 10 minutos."
}

Exemplo de Bloqueio Inteligente (O que voc√™ pediu):
JSON

{
  "timestamp": 1735661000,
  "type": "skipped",
  "source": "schedule",
  "status": "blocked",
  "reason_code": "HIGH_MOISTURE", // Para o app traduzir
  "message": "Agendamento cancelado: Umidade do solo (85%) acima do m√°ximo configurado (80%).",
  "weather_data": { // Opcional: Salvar evid√™ncia
      "rain_forecast": "0mm",
      "current_moisture": 85
  }
}

Exemplo de Bloqueio por Chuva (Previs√£o):
JSON

{
  "timestamp": 1735665000,
  "type": "skipped",
  "status": "blocked",
  "reason_code": "RAIN_PREDICTED",
  "message": "Agendamento cancelado: Previs√£o de chuva forte (15mm) na pr√≥xima hora.",
}

üí° Por que essa estrutura √© "Profissional"?

    Custo (Reads/Writes): Quando o usu√°rio abre o App, ele l√™ apenas users e devices. Ele n√£o baixa o hist√≥rico (history) a menos que clique na aba "Hist√≥rico". Isso economiza muito dinheiro de banco de dados no futuro.

    Escalabilidade: Como o hist√≥rico √© uma sub-cole√ß√£o, ele pode crescer infinitamente sem deixar o carregamento do dispositivo lento.

    Auditoria: Se o cliente reclamar "Minha planta morreu seca!", voc√™ abre o history e prova: "O sistema n√£o regou dia 25 porque choveu 50mm". Isso √© vital para um produto comercial.

üíæ Commit de Planejamento

Como voc√™ pediu (e √© o correto), vamos salvar o projeto antes de come√ßar a codar as novas telas.

No terminal, na pasta raiz do projeto:
Bash

git add .
git commit -m "docs: architecture definition for database schema, multi-tenancy and audit logs"
git push

üöÄ Pr√≥ximo Passo Pr√°tico

Agora que o banco est√° planejado, precisamos criar a Tela de Cadastro (Sign Up) no Flutter para que os usu√°rios possam existir no banco de dados.

O plano de a√ß√£o agora:

    Criar a tela SignUpScreen: Campos Nome, Email, Senha.

    L√≥gica de Registro: Ao criar a conta no Firebase Auth, criar automaticamente o documento na cole√ß√£o users com o array my_devices vazio.

    Criar a tela DevicesListScreen: Que vai substituir aquela tela de "Bem-vindo" provis√≥ria.
